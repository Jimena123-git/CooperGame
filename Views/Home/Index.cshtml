@model HomeViewModel
@using static CooperGame.Models.Partida

<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Coopera — Versión Botones (V1)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-dark text-light">

    <!-- Modal para crear jugador -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-white" style="background:#0b1220; opacity:0.95; border:1px solid #223150;">
                <div class="modal-header border-bottom border-secondary-subtle">
                    <h5 class="modal-title">Ingresar nombre</h5>
                </div>
                <div class="modal-body">
                    <form method="post" action="/Jugador/Registrar">
                        <div class="mb-3">
                            <label class="form-label">Nombre del jugador</label>
                            <input type="text" name="nombre" class="form-control" required />
                        </div>
                        <button type="submit" class="btn btn-success w-100">Entrar al juego</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-dark border-bottom border-secondary-subtle" style="background:#0b1220;">
        <div class="container">
            <span class="fw-bold">Coopera</span>
            <span class="badge rounded-pill text-bg-success">V1 (Botones)</span>
            <a class="btn btn-sm btn-outline-light" href="@Url.Action("V2", "Home")">Ir a V2</a>
        </div>
    </nav>

    <div class="container mt-4">
        @if (Model.JugadorId > 0)
        {
            <h4 class="text-white mb-3">Jugador actual: <strong>@Model.JugadorNombre</strong></h4>
        }

        <!-- Cartas de recursos alineadas horizontalmente -->
        <div class="row">
            @foreach (TipoRecurso tipo in Enum.GetValues(typeof(TipoRecurso)))
            {
                int cantidadRecolectada = Model.Registros
                                    .Where(r => r.Tipo == tipo)
                                    .Sum(r => r.Cantidad);
                Console.WriteLine(cantidadRecolectada);
                int metaRecurso = tipo switch
                {
                    TipoRecurso.Madera => Model.Partida.MetaMadera,
                    TipoRecurso.Piedra => Model.Partida.MetaPiedra,
                    TipoRecurso.Comida => Model.Partida.MetaComida,
                    _ => 100
                };

                bool completado = cantidadRecolectada >= metaRecurso;

                <div class="col-md-4 mb-3">
                    <div class="card text-white shadow-sm" style="background:#0b1220; opacity:0.95; border:1px solid #223150;">
                        <div class="card-body text-center">
                            <h5 class="card-title">@tipo</h5>
                            <p class="card-text display-6">@cantidadRecolectada / @metaRecurso</p>
                            <form asp-action="Recolectar" method="post">
                                <input type="hidden" name="tipo" value="@tipo" />
                                <input type="hidden" name="cantidad" value="1" />
                                <button type="submit" class="btn btn-success btn-sm" @(completado || Model.JugadorId == 0 ? "disabled" : "")>+1</button>
                            </form>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (Model.EstadoPartida == EstadoPartida.PresentandoResultados)
        {
            <div class="modal fade show" style="display:block;" id="resultsModal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content" style="background:#121a2b; border:1px solid #223150;">
                        <div class="modal-header border-bottom border-secondary-subtle">
                            <h5 class="modal-title text-white">🎉 ¡Partida Completada!</h5>
                        </div>
                        <div class="modal-body">
                            <h6 class="text-white mb-3">Contribuciones por jugador:</h6>
                            <div class="table-responsive">
                                <table class="table table-dark table-striped">
                                    <thead>
                                        <tr>
                                            <th>Jugador</th>
                                            <th>🪵 Madera</th>
                                            <th>🪨 Piedra</th>
                                            <th>🍎 Comida</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{
                                            var jugadores = Model.Registros.Select(r => r.Jugador).Distinct();
                                        }
                                        @foreach (var jugador in jugadores)
                                        {
                                            int madera = Model.Registros.Where(r => r.IdJugador == jugador.IdJugador && r.Tipo == TipoRecurso.Madera).Sum(r => r.Cantidad);
                                            int piedra = Model.Registros.Where(r => r.IdJugador == jugador.IdJugador && r.Tipo == TipoRecurso.Piedra).Sum(r => r.Cantidad);
                                            int comida = Model.Registros.Where(r => r.IdJugador == jugador.IdJugador && r.Tipo == TipoRecurso.Comida).Sum(r => r.Cantidad);
                                            <tr>
                                                <td>@jugador.Nombre</td>
                                                <td>@madera</td>
                                                <td>@piedra</td>
                                                <td>@comida</td>
                                                <td>@(madera + piedra + comida)</td>
                                            </tr>
                                        }
                                        <tr class="table-warning">
                                            <td><strong>TOTALES</strong></td>
                                            <td>@Model.Registros.Where(r => r.Tipo == TipoRecurso.Madera).Sum(r => r.Cantidad)</td>
                                            <td>@Model.Registros.Where(r => r.Tipo == TipoRecurso.Piedra).Sum(r => r.Cantidad)</td>
                                            <td>@Model.Registros.Where(r => r.Tipo == TipoRecurso.Comida).Sum(r => r.Cantidad)</td>
                                            <td>@Model.Registros.Sum(r => r.Cantidad)</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <form method="post" asp-action="ReiniciarPartida" asp-controller="Home">
                            <input type="hidden" name="idPartida" value="@Model.Partida.IdPartida" />
                            <button type="submit" class="btn btn-success btn-lg">🔄 Reiniciar Partida</button>
                        </form>
                    </div>
                </div>
            </div>
        }

        @if (Model.JugadorId == 0)
        {
            <script>
                window.onload = () => {
                    var modal = new bootstrap.Modal(document.getElementById('registerModal'));
                    modal.show();
                }
            </script>
        }

</body>
</html>
